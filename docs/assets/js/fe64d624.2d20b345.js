"use strict";(self.webpackChunkliveviewjs_com=self.webpackChunkliveviewjs_com||[]).push([[4919],{876:(e,t,r)=>{r.d(t,{Zo:()=>d,kt:()=>w});var n=r(2784);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var l=n.createContext({}),p=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):a(a({},t),e)),r},d=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},v=n.forwardRef((function(e,t){var r=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),v=p(r),w=i,u=v["".concat(l,".").concat(w)]||v[w]||c[w]||o;return r?n.createElement(u,a(a({ref:t},d),{},{components:r})):n.createElement(u,a({ref:t},d))}));function w(e,t){var r=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=r.length,a=new Array(o);a[0]=v;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,a[1]=s;for(var p=2;p<o;p++)a[p]=r[p];return n.createElement.apply(null,a)}return n.createElement.apply(null,r)}v.displayName="MDXCreateElement"},3451:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var n=r(7896),i=(r(2784),r(876));const o={sidebar_position:3},a="LiveViewServerAdaptor",s={unversionedId:"webserver-integration/liveview-server-adaptor",id:"webserver-integration/liveview-server-adaptor",title:"LiveViewServerAdaptor",description:"LiveViewJS provides an interface that you can implement to integrate with your webserver of choice. This interface is",source:"@site/docs/12-webserver-integration/liveview-server-adaptor.md",sourceDirName:"12-webserver-integration",slug:"/webserver-integration/liveview-server-adaptor",permalink:"/docs/webserver-integration/liveview-server-adaptor",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Webserver Integration",permalink:"/docs/webserver-integration/overview"},next:{title:'Support Webserver "X"',permalink:"/docs/webserver-integration/support-webserver-x"}},l={},p=[{value:"Required Methods",id:"required-methods",level:2},{value:"Digging into NodeExpressLiveViewServer",id:"digging-into-nodeexpressliveviewserver",level:2},{value:"HTTP Middleware",id:"http-middleware",level:3},{value:"Websocket Middleware",id:"websocket-middleware",level:3}],d={toc:p};function c(e){let{components:t,...r}=e;return(0,i.kt)("wrapper",(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"liveviewserveradaptor"},"LiveViewServerAdaptor"),(0,i.kt)("p",null,"LiveViewJS provides an interface that you can implement to integrate with your webserver of choice. This interface is\ncalled ",(0,i.kt)("inlineCode",{parentName:"p"},"LiveViewServerAdaptor"),". This is the interface that is implemented by the ",(0,i.kt)("inlineCode",{parentName:"p"},"NodeExpressLiveViewServer")," (and\n",(0,i.kt)("inlineCode",{parentName:"p"},"DenoOakLiveViewServer"),")."),(0,i.kt)("h2",{id:"required-methods"},"Required Methods"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"LiveViewServerAdaptor")," requires that you implement the following methods:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"httpMiddleware()")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"wsMiddleware()"))),(0,i.kt)("h2",{id:"digging-into-nodeexpressliveviewserver"},"Digging into NodeExpressLiveViewServer"),(0,i.kt)("p",null,"The implementation behind the ",(0,i.kt)("inlineCode",{parentName:"p"},"NodeExpressLiveViewServer")," is where the magic of mapping HTTP and websocket requests to\nLiveViewJS routes happens."),(0,i.kt)("h3",{id:"http-middleware"},"HTTP Middleware"),(0,i.kt)("p",null,"Let's look at the ExpressJS implementation of the ",(0,i.kt)("inlineCode",{parentName:"p"},"httpMiddleware")," method:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"httpMiddleware(): RequestHandler {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const adaptor = new ExpressRequestAdaptor(req, res, this.serDe);\n      const { getRequestPath } = adaptor;\n\n      // look up LiveView for route\n      const liveview = this.router[getRequestPath()];\n      if (!liveview) {\n        // no LiveView found for route so call next() to\n        // let a possible downstream route handle the request\n        next();\n        return;\n      }\n\n      // defer to liveviewjs to handle the request\n      const rootViewHtml = await handleHttpLiveView(\n        nanoid,\n        nanoid,\n        liveview,\n        adaptor,\n        this.htmlPageTemplate,\n        this.liveTitleOptions,\n        this.wrapperTemplate\n      );\n\n      // check if LiveView calls for a redirect and if so, do it\n      if (adaptor.redirect) {\n        res.redirect(adaptor.redirect);\n        return;\n      }\n\n      // otherwise render the LiveView HTML\n      res.format({\n        html: () => {\n          res.send(rootViewHtml);\n        },\n      });\n    } catch (error) {\n      next(error);\n    }\n  };\n}\n")),(0,i.kt)("p",null,"In summary, the ",(0,i.kt)("inlineCode",{parentName:"p"},"httpMiddleware")," method does the following:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"It creates an ",(0,i.kt)("inlineCode",{parentName:"li"},"ExpressRequestAdaptor")," instance that wraps the ExpressJS ",(0,i.kt)("inlineCode",{parentName:"li"},"Request")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"Response")," objects so they can\nbe used by LiveViewJS."),(0,i.kt)("li",{parentName:"ol"},"It uses the LiveViewRouter to see if there is a LiveView registered for the request path."),(0,i.kt)("li",{parentName:"ol"},"If there is a LiveView registered for the request path, it calls ",(0,i.kt)("inlineCode",{parentName:"li"},"handleHttpLiveView")," to handle the request.\n",(0,i.kt)("inlineCode",{parentName:"li"},"handleHttpLiveView")," is provided by LiveViewJS that connect the request to the LiveView."),(0,i.kt)("li",{parentName:"ol"},"If there is no LiveView registered for the request path, it calls ",(0,i.kt)("inlineCode",{parentName:"li"},"next()")," to let the next middleware in the chain\nhandle the request."),(0,i.kt)("li",{parentName:"ol"},"We check for redirects and if there is one, we do it."),(0,i.kt)("li",{parentName:"ol"},"Otherwise, we render the LiveView HTML.")),(0,i.kt)("h3",{id:"websocket-middleware"},"Websocket Middleware"),(0,i.kt)("p",null,"Let's look at the ExpressJS implementation of the ",(0,i.kt)("inlineCode",{parentName:"p"},"wsMiddleware")," method:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},'wsMiddleware(): (wsServer: WebSocketServer) => Promise<void> {\n  return async (wsServer: WebSocketServer) => {\n    // send websocket requests to the LiveViewJS message router\n    wsServer.on("connection", (ws) => {\n      const connectionId = nanoid();\n      ws.on("message", async (message, isBinary) => {\n        // pass websocket messages to LiveViewJS\n        await this._wsRouter.onMessage(connectionId, message, new NodeWsAdaptor(ws), isBinary);\n      });\n      ws.on("close", async () => {\n        // pass websocket close events to LiveViewJS\n        await this._wsRouter.onClose(connectionId);\n      });\n    });\n  };\n}\n')),(0,i.kt)("p",null,"In summary, the ",(0,i.kt)("inlineCode",{parentName:"p"},"wsMiddleware")," method listens for websocket connections, messages, and close events and passes them to\nthe LiveViewJS message router. The ",(0,i.kt)("inlineCode",{parentName:"p"},"wsRouter")," knows how to route websocket messages to the correct LiveView and handle\nthe websocket lifecycle. Not much to see here since it's all handled by LiveViewJS."),(0,i.kt)("p",null,"That's more or less it modulo the ",(0,i.kt)("inlineCode",{parentName:"p"},"ExpressRequestAdaptor"),". The ",(0,i.kt)("inlineCode",{parentName:"p"},"ExpressRequestAdaptor")," is a wrapper around the ExpressJS\n",(0,i.kt)("inlineCode",{parentName:"p"},"Request")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Response")," objects that provides a common interface for LiveViewJS to use. This is another necessary step\nto normalize any differences between webserver implementations."))}c.isMDXComponent=!0}}]);